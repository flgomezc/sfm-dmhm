\section{Methodology}

The key element to connect SFR with halo mass from simulations is the observed UVLF. 
If there exist a function whom gives to each halo a UV luminosity then is posible to 
reproduce UVLF from DMH catalogs. The fitting parameters can be explored using a 
Markov Chain Monte-Carlo (MCMC) implementation. Once the parameters are found, 
the SFR-Halo Mass relation have been found.

We use the dark matter halo catalog from the Big MultiDark Plank 1 (MDPL) Simulation 
\citep{klypin14} with 2013 Planck cosmology \citep{planck1}. MDPL is quite similar to the 
Big Bolshoi ($1 \textrm{Gpc h}^{-1}$) \citep{prada12} and 
its predecesor Bolshoi \citep{klypin11} ($250 \textrm{Mpc h}^{-1}$), booth of them with 
WMAP5 cosmology, but MDPL has bigger mass resolution.  Those halo catalogs are 
available at the MultiDark Database\footnote{\url{http://www.multidark.org}} 
\citep{riebe13}.

The MDPL run is a N-body dark matter only simulation based on the L-Gadget2 
code. The simulated volume is a cubic box of $1 \textrm{Gpc h}^{-1}$ side length. 
It has $3840^3$ dark matter particles of 
$1.51\times 9 \textrm{M}_{\odot} \textrm{h}^{-1}$ mass each one.
The 2013 Planck cosmology is defined by the following parameters: $\Omega_M = 0.307$, 
$\Omega_B = 0.048$, $\Omega_\Lambda = 0.730$, $\sigma_8 = 0.829$, $n_s = 0.96$ and 
$H_0 = 67.8$. The DMH Catalog at $z=6$ contains $\sim 10.9 \times 10^7$ 
halos, to avoid incompleteness in the low mass end, halos with mass below 
$10^{10.3} \textrm{M}_{\odot} \textrm{h}^{-1}$ are rejected. In order to study how 
cosmic variance can affect measurements, the original catalog is divided into 64 small 
cubic boxes, with a similar volume to the observations.

The following treatment is applied to every one small box.

The halo abundance matching technique has been widely used \citep{colin99, kravtsov04}
resulting in good reproduction of the observed galaxy clustering. \citep{conroy06, lee09}. 
Here we use the simplest case with few premises: 
\begin{enumerate}
 \item Each halo in the catalog hosts one galaxy. There are not empty
halos, also none of halos has two or more galaxies.
 \item The UV luminosity of each galaxy is function of one variable; the mass of
the DMH in which is located. This function must be monotone, this guarantees that most 
massive halos will host the most luminous galaxies in the same volume.
\end{enumerate}

\subsection{Fitting Model}

The observed UV Luminosity Function has two slopes. To reproduce it we decide to use the
 four parameter model:
  \begin{equation}\label{eqn:luminosity}
  L_{\textrm{\small{UV}}} (M) = L_{0} M \left[ \left( \frac{M}{M_0}\right)^{-\beta} 
		   + \left( \frac{M}{M_0}\right)^{\gamma} 
               \right]^{-1}
  \end{equation}
where $M$ is the hosting DMH mass, $L_{0}$ is a normalization constant, $M_0$
is the critical mass where the luminosity function has a slope change, 
$\beta$ and $\gamma$ are the slopes. This equation has a similar fashion to the
mass to light relation \citep{vandenbosch03} and the mean relation between
stellar mas of a galaxy and the mass of its halo used by \citet{moster10}.


\subsection{Dust Attenuation}
 
Dust in star forming galaxies absorbs part of the UV radiation and reemits on IR. The more 
massive is the galaxy then more dust contains and dust attenuation will be greater. The 
relation between dust attenuation and magnitude have been already studied, with this relation 
we can infer the dust-free UV luminosity of a galaxy from observations, resulting in  a more 
accurate inferred SFR.

The UV Spectral Slope $\beta$ was introduced by \citet{meurer99} as a UV color to 
study dust attenuation in local starburst galaxies and extrapolating to high redshift galaxies. 
This index appears when a power law fitting is performed over the spectral flux $f$ 
as function of the wavelength $\lambda$;
\[ f \propto \lambda^\beta.\]
The relation for ultra-violet attenuation at $1600 \textrm{\AA}$ they found is:
\begin{equation}
A_{1600} = 4.43 + 1.99 \beta,
\end{equation}
with $A_{1600}$ in magnitude units. 

Due LBGs have more similar spectra properties to local starburst galaxies rather than AGNs 
for example, we can assume that local calibration of $\beta-A_{1600}$ can be applied also 
for LBGs,
%%% From Meurer99
``The main requirement is that the data include fluxes in two broad bands or coarse spectra 
covering the rest-frame UV.''


\citet{bouwens12b} uses the fluxes on different bands to estimate $\beta$ on each LBG 
candidate found with $z \sim 4-7$. After in redshift groups they found a linear relation 
between $\beta$ and the UV magnitude:
\begin{equation}
\langle \beta \rangle = \frac{d \beta}{d M_{UV}} \left( M_{UV,AB}+19.5 \right) 
                                   + \beta_{M_{UV}=-19.5}
\end{equation}
with $ \beta_{M_{UV}=-19.5} = -2.20$ and $d \beta/d M_{UV} = -0.21$ at $z=5.9$.

\citet{smit12} used the aforementioned relations to infer the corrected luminosity functions,
i.e. dust-free luminosity functions, and the corrected SFR at $z=4$. 

Here we use the inverse relation, starting from the intrinsic or dust-free galaxy magnitude, 
obtaining the observed magnitude:
\begin{equation}\label{eqn. dust attenuation}
  M_{obs} = \begin{cases} 
                         \frac{M_{int}-4.616}{1.259}, &\mbox{if } A>0 \\
                         M_{int}, &\mbox{else}
                   \end{cases}.
\end{equation}


\subsection{MCMC}
We used a Markov Chain Monte Carlo method to find the best parameters and its 
uncertainties over each one of the boxes and each observational dataset.

Observational data set to fit is selected.
A halo catalog of a cubic box of length 250 Mpc h-1 is selected.
Initial parameters are introduced.

An UV luminosity is given to each halo as function of his mass according to equation
 \ref{eqn:luminosity}.
Luminosity is converted to magnitude using:
  \[ M_{UV} = 51.82 - 2.5 \log_{10}(L_{UV}). \]
If we consider the dust attenuation im the equation \ref{eqn. dust attenuation} we have
a dust-corrected UV Luminosity Function.

The luminosity function is constructed as an histogram of the magnitudes normalized by 
the volume of the catalog. Each observed luminosity function has a different bin range.

Once having the LF, we compare our LF against observed LF. Our likelihood estimator is 
the sum of the square difference over each bin, divided by the number of degrees of 
freedom. We worked on the logarithmic space of luminosities to have a good fitting on
six decades.

\[ \chi^2  = \sum_{i=o}^{n}\left( x_{i,obs} - x_{i,fit} \right)^2 \]


\[ \mathcal{L} \propto \exp \left( \frac{\chi ^2}{n} \right) \]

Then we have a small variation on the parameters, it gives us a new LF and a new 
likelihood estimator $\chi^2$. 

We compare the new fitting versus the old fitting.



Some restrictions where imposed over two parameters to guarantee convergence in the 
MCMC method: $0 \leq \alpha \leq 1.8 $  and $\gamma \geq 0$.






%MCMC, maximum likelihood.

%Python, Ipython Notebook, Scipy, Matplotlib, Numpy. Astropy
Finally, the UV luminosity for each galaxy can be directly related with SFR according 
to \citet{madau98}.
This model is accurate within the range of $10^8 - 10^9 \textrm{yr}$\citep{kennicutt98}.
The relation between UV luminosity and Star Formation Rate \citep{madau98,kennicutt98} 
is given by:
\begin{equation}
 \textrm{SFR}\left(M_\odot \textrm{yr}^{-1}\right) 
      = 1.4 \times 10^{-28} L_{\nu} \left( \textrm{erg s}^{-1}\textrm{Hz}^{-1} 
	\right)
\end{equation}
